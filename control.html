<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="color-scheme" content="dark" />

    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://telegram.org" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="importmap">
      {
        "imports": {
          "alpinejs": "https://cdn.jsdelivr.net/npm/alpinejs@3/+esm",
          "jsbarcode": "https://cdn.jsdelivr.net/npm/jsbarcode@3/+esm"
        }
      }
    </script>

    <style type="text/tailwindcss">
      @theme {
        --color-bg: oklch(0% 0 0);
        --color-surface: oklch(12% 0.005 285);
        --color-surface-elevated: oklch(18% 0.008 285);
        --color-surface-tertiary: oklch(24% 0.008 285);
        --color-border: oklch(30% 0.012 285 / 0.5);
        --color-border-subtle: oklch(25% 0.008 285 / 0.4);
        --color-separator: oklch(35% 0.01 285 / 0.35);
        --color-text-primary: oklch(97% 0 0);
        --color-text-secondary: oklch(82% 0.01 285);
        --color-text-tertiary: oklch(62% 0.015 285);
        --color-text-muted: oklch(48% 0.02 285);
        --color-success: oklch(75% 0.18 150);
        --color-error: oklch(68% 0.22 25);
        --color-warning: oklch(80% 0.16 75);
        --color-accent: oklch(68% 0.2 260);
        --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
        --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @layer base {
        *,
        *::before,
        *::after {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          -webkit-tap-highlight-color: transparent;
        }

        html {
          background: var(--color-bg);
          color: var(--color-text-primary);
          font-family:
            -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
            system-ui, sans-serif;
          font-feature-settings:
            "kern" 1,
            "liga" 1;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          text-rendering: optimizeLegibility;
          scroll-behavior: smooth;
        }

        body {
          min-height: 100dvh;
          overscroll-behavior: none;
          overflow-x: hidden;
          scrollbar-width: none;
          padding: env(safe-area-inset-top) env(safe-area-inset-right)
            calc(env(safe-area-inset-bottom) + 7rem) env(safe-area-inset-left);
        }

        body::-webkit-scrollbar {
          display: none;
        }

        [x-cloak] {
          display: none !important;
        }

        @media (prefers-reduced-motion: reduce) {
          *,
          *::before,
          *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
          }
        }
      }

      @layer components {
        .card {
          background: linear-gradient(
            180deg,
            var(--color-surface-elevated) 0%,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 60%,
                var(--color-surface)
              )
              100%
          );
          border: 1px solid var(--color-border);
          border-radius: 1.25rem;
          overflow: hidden;
          transition:
            transform 200ms var(--ease-out-expo),
            box-shadow 200ms var(--ease-out-expo);
        }

        .card:active {
          transform: scale(0.98);
        }

        .card:hover {
          box-shadow: 0 2px 20px oklch(0% 0 0 / 0.3);
        }

        .empty-state {
          background:
            radial-gradient(
              ellipse at 30% 20%,
              oklch(65% 0.2 260 / 0.06) 0%,
              transparent 60%
            ),
            radial-gradient(
              ellipse at 70% 80%,
              oklch(75% 0.18 150 / 0.04) 0%,
              transparent 60%
            ),
            linear-gradient(
              145deg,
              var(--color-surface) 0%,
              var(--color-surface-elevated) 100%
            );
          border: 1.5px dashed var(--color-border);
          border-radius: 1.75rem;
        }

        .empty-icon {
          background: linear-gradient(
            145deg,
            var(--color-surface-elevated) 0%,
            var(--color-surface-tertiary) 100%
          );
          border-radius: 1.5rem;
          box-shadow:
            inset 0 1px 0 oklch(100% 0 0 / 0.06),
            0 4px 16px oklch(0% 0 0 / 0.2);
        }

        .barcode-container {
          background: linear-gradient(180deg, #ffffff 0%, #f8f8fa 100%);
          border-radius: 0 0 1.125rem 1.125rem;
          padding: 1rem 1.25rem;
        }

        .barcode-container svg {
          width: 100% !important;
          height: auto !important;
          max-height: 4.5rem;
          display: block;
        }

        .code-display {
          font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
          font-variant-numeric: tabular-nums;
          letter-spacing: 0.1em;
          font-weight: 600;
        }

        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border: none;
          cursor: pointer;
          transition:
            transform 150ms var(--ease-out-expo),
            opacity 150ms var(--ease-out-expo),
            background 150ms ease;
          user-select: none;
        }

        .btn:active {
          transform: scale(0.92);
        }

        .btn-delete {
          background: oklch(68% 0.22 25 / 0.1);
          border: 1px solid oklch(68% 0.22 25 / 0.2);
          color: var(--color-error);
          border-radius: 0.875rem;
        }

        .btn-delete:hover {
          background: oklch(68% 0.22 25 / 0.18);
        }

        .btn-copy {
          background: transparent;
          border-radius: 0.75rem;
          padding: 0.5rem 0.75rem;
          position: relative;
        }

        .btn-copy:hover {
          background: oklch(100% 0 0 / 0.05);
        }

        .btn-copy::after {
          position: absolute;
          bottom: -1.5rem;
          left: 0.75rem;
          font-size: 0.6875rem;
          font-family: -apple-system, system-ui, sans-serif;
          letter-spacing: 0;
          font-weight: 400;
          color: var(--color-text-muted);
          opacity: 0;
          transition: opacity 200ms ease;
          pointer-events: none;
          white-space: nowrap;
        }

        .btn-copy:hover::after {
          opacity: 1;
        }

        .badge {
          display: inline-flex;
          align-items: center;
          gap: 0.375rem;
          padding: 0.4rem 0.9rem;
          font-size: 0.8125rem;
          font-weight: 500;
          border-radius: 9999px;
          background: var(--color-surface-elevated);
          border: 1px solid var(--color-border-subtle);
          color: var(--color-text-secondary);
        }

        .toast {
          background: oklch(14% 0.01 285 / 0.94);
          backdrop-filter: blur(24px) saturate(180%);
          -webkit-backdrop-filter: blur(24px) saturate(180%);
          border: 1px solid var(--color-border);
          border-radius: 9999px;
          box-shadow:
            0 8px 32px oklch(0% 0 0 / 0.5),
            inset 0 1px 0 oklch(100% 0 0 / 0.06);
        }

        .skeleton {
          background: linear-gradient(
            90deg,
            var(--color-surface) 25%,
            var(--color-surface-elevated) 50%,
            var(--color-surface) 75%
          );
          background-size: 200% 100%;
          animation: shimmer 1.8s ease-in-out infinite;
          border-radius: 0.5rem;
        }

        .header-glow {
          background: radial-gradient(
            ellipse 50% 80% at 50% 0%,
            oklch(68% 0.2 260 / 0.08) 0%,
            transparent 100%
          );
        }
      }

      @layer utilities {
        @keyframes fade-in {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes slide-up {
          from {
            opacity: 0;
            transform: translateY(1.25rem);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes shimmer {
          0% {
            background-position: 200% 0;
          }
          100% {
            background-position: -200% 0;
          }
        }

        @keyframes pulse-soft {
          0%,
          100% {
            opacity: 1;
          }
          50% {
            opacity: 0.7;
          }
        }

        .animate-fade {
          animation: fade-in 350ms var(--ease-out-expo) forwards;
        }

        .animate-slide {
          animation: slide-up 450ms var(--ease-out-expo) forwards;
        }

        .text-balance {
          text-wrap: balance;
        }
      }
    </style>
  </head>

  <body x-cloak x-data="app" class="flex flex-col select-none">
    <div
      class="header-glow pointer-events-none fixed inset-x-0 top-0 z-0 h-48"
      aria-hidden="true"
    ></div>

    <main
      class="relative z-10 mx-auto flex w-full max-w-md flex-1 flex-col px-4"
    >
      <header class="animate-fade pb-6 pt-8 text-center">
        <h1 class="text-balance text-3xl font-bold tracking-tight">Control</h1>
        <p class="mt-1.5 text-sm text-text-muted">by feedod</p>
      </header>

      <section class="flex-1 pb-8" aria-label="Список отсканированных кодов">
        <template x-if="!loading && items.length === 0">
          <div class="animate-slide">
            <div
              class="empty-state flex flex-col items-center px-6 py-12 text-center"
            >
              <div
                class="empty-icon mb-6 flex h-20 w-20 items-center justify-center"
              >
                <svg
                  class="h-10 w-10 text-text-muted"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5Z"
                  />
                </svg>
              </div>
              <h2 class="text-balance text-xl font-semibold text-text-primary">
                Пока здесь пусто
              </h2>
              <p
                class="mt-3 max-w-[17rem] text-sm leading-relaxed text-text-muted"
              >
                Нажмите «Сканировать» внизу экрана, чтобы добавить первый
                штрих-код
              </p>
              <div
                class="mt-7 flex items-center gap-2 text-xs font-medium text-text-tertiary"
              >
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 6h.008v.008H6V6Z"
                  />
                </svg>
                <span>Поддержка форматов EAN-8 и EAN-13</span>
              </div>
            </div>
          </div>
        </template>

        <template x-if="loading">
          <div class="space-y-3" aria-busy="true" aria-label="Загрузка данных">
            <template x-for="i in 3" :key="i">
              <div class="card">
                <div class="p-4">
                  <div class="skeleton h-5 w-36"></div>
                </div>
                <div class="skeleton h-20 rounded-none"></div>
              </div>
            </template>
          </div>
        </template>

        <template x-if="!loading && items.length > 0">
          <div class="animate-fade">
            <div class="mb-5 flex justify-center">
              <div class="badge">
                <svg
                  class="h-3.5 w-3.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
                  />
                </svg>
                <span
                  >Всего кодов:
                  <strong
                    class="text-text-primary"
                    x-text="items.length"
                  ></strong
                ></span>
              </div>
            </div>

            <ul class="space-y-3" role="list">
              <template x-for="(item, index) in items" :key="item.id">
                <li
                  class="card animate-slide"
                  :style="`animation-delay: ${Math.min(index * 50, 300)}ms`"
                  x-init="$nextTick(() => renderBarcode(item))"
                >
                  <div class="flex items-center justify-between gap-3 p-4 pb-3">
                    <button
                      type="button"
                      class="btn btn-copy code-display flex-1 text-left text-lg text-text-primary"
                      @click="copy(item.code)"
                      x-text="item.code"
                      :title="`Скопировать ${item.code}`"
                      :aria-label="`Скопировать код ${item.code} в буфер обмена`"
                    ></button>
                    <button
                      type="button"
                      class="btn btn-delete h-10 w-10 flex-shrink-0"
                      @click="remove(item.id)"
                      :aria-label="`Удалить код ${item.code}`"
                    >
                      <svg
                        class="h-[1.125rem] w-[1.125rem]"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.5"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                        />
                      </svg>
                    </button>
                  </div>

                  <div class="barcode-container">
                    <svg :id="`bc-${item.id}`" aria-hidden="true"></svg>
                  </div>
                </li>
              </template>
            </ul>
          </div>
        </template>
      </section>
    </main>

    <div
      x-show="toast.visible"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 translate-y-4 scale-95"
      x-transition:enter-end="opacity-100 translate-y-0 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 translate-y-0 scale-100"
      x-transition:leave-end="opacity-0 translate-y-4 scale-95"
      class="toast fixed bottom-28 left-1/2 z-50 -translate-x-1/2 px-5 py-3"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
      <div class="flex items-center gap-2.5 whitespace-normal">
        <template x-if="toast.type === 'success'">
          <svg
            class="h-5 w-5 text-success"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m4.5 12.75 6 6 9-13.5"
            />
          </svg>
        </template>
        <template x-if="toast.type === 'warning'">
          <svg
            class="h-5 w-5 text-warning"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
            />
          </svg>
        </template>
        <template x-if="toast.type === 'error'">
          <svg
            class="h-5 w-5 text-error"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
            />
          </svg>
        </template>
        <span
          class="text-sm font-medium text-text-primary"
          x-text="toast.message"
        ></span>
      </div>
    </div>

    <script type="module">
      import Alpine from "alpinejs";
      import JsBarcode from "jsbarcode";

      const STORAGE_KEY = "control_scanner_v2";
      const EAN_PATTERN = /^(\d{8}|\d{13})$/;
      const MAX_INPUT_LENGTH = 2048;
      const TOAST_DURATION = 2500;

      const tg = globalThis.Telegram?.WebApp;

      const TelegramApp = Object.freeze({
          init() {
              if (!tg) return false;
              tg.ready();
              tg.requestFullscreen?.();
              tg.disableVerticalSwipes?.();
              tg.setHeaderColor?.("#000000");
              tg.setBackgroundColor?.("#000000");
              tg.setBottomBarColor?.("#0a0a0a");
              return true;
          },

          haptic(type = "light") {
              tg?.HapticFeedback?.impactOccurred?.(type);
          },

          notify(type = "success") {
              tg?.HapticFeedback?.notificationOccurred?.(type);
          },

          async cloudGet(key) {
              if (!tg?.CloudStorage) return null;
              return new Promise((resolve) => {
                  tg.CloudStorage.getItem(key, (err, val) => {
                      resolve(err || !val ? null : val);
                  });
              });
          },

          async cloudSet(key, value) {
              if (!tg?.CloudStorage) return;
              return new Promise((resolve) => {
                  tg.CloudStorage.setItem(key, value, () => resolve());
              });
          },

          confirm(message) {
              return new Promise((resolve) => {
                  if (tg?.showConfirm) {
                      tg.showConfirm(message, (confirmed) =>
                          resolve(Boolean(confirmed)),
                      );
                  } else {
                      resolve(globalThis.confirm(message));
                  }
              });
          },
      });

      const AudioManager = (() => {
          let ctx = null;

          const getContext = () => {
              if (!ctx) {
                  const AC = globalThis.AudioContext ?? globalThis.webkitAudioContext;
                  if (AC) ctx = new AC();
              }
              return ctx;
          };

          return Object.freeze({
              async playSuccess() {
                  const c = getContext();
                  if (!c) return;
                  if (c.state === "suspended") await c.resume();

                  const t = c.currentTime;
                  const osc = c.createOscillator();
                  const gain = c.createGain();

                  osc.type = "sine";
                  osc.frequency.setValueAtTime(880, t);
                  osc.frequency.setValueAtTime(1320, t + 0.08);

                  gain.gain.setValueAtTime(0.07, t);
                  gain.gain.exponentialRampToValueAtTime(0.001, t + 0.18);

                  osc.connect(gain).connect(c.destination);
                  osc.start(t);
                  osc.stop(t + 0.18);
              },
          });
      })();

      const extractCode = (text) => {
          if (!text || typeof text !== "string") return null;

          const trimmed = text.trim();
          if (!trimmed || trimmed.length > MAX_INPUT_LENGTH) return null;

          const code = trimmed.startsWith("CEN;") ?
              (trimmed.split(";").at(1) ?? "") :
              trimmed;

          return EAN_PATTERN.test(code) ? code : null;
      };

      Alpine.data("app", () => ({
          loading: true,
          scanning: false,
          items: [],
          codes: new Set(),
          counter: 0,
          toast: {
              visible: false,
              message: "",
              type: "success"
          },
          _toastTimer: null,

          async init() {
              TelegramApp.init();
              await this.load();
              this.loading = false;
              this.setupButtons();
              this.$watch("items.length", () => this.updateSecondaryButton());
          },

          destroy() {
              if (this._toastTimer) clearTimeout(this._toastTimer);
          },

          setupButtons() {
              if (!tg) return;

              tg.MainButton.setText("Сканировать");
              tg.MainButton.setParams({
                  color: "#30d158",
                  text_color: "#ffffff",
              });
              tg.MainButton.show();
              tg.MainButton.onClick(() => this.scan());

              if (tg.SecondaryButton) {
                  tg.SecondaryButton.setText("Очистить всё");
                  tg.SecondaryButton.setParams({
                      color: "#0a0a0a",
                      text_color: "#ff453a",
                      position: "bottom",
                  });
                  tg.SecondaryButton.onClick(() => this.confirmClear());
              }

              this.updateSecondaryButton();
          },

          updateSecondaryButton() {
              if (!tg?.SecondaryButton) return;
              if (this.items.length > 0) {
                  tg.SecondaryButton.show();
              } else {
                  tg.SecondaryButton.hide();
              }
          },

          scan() {
              if (this.scanning) return;
              this.scanning = true;
              TelegramApp.haptic("light");

              if (!tg?.showScanQrPopup) {
                  this.showToast("QR-сканер недоступен", "error");
                  this.scanning = false;
                  return;
              }

              tg.showScanQrPopup({
                      text: "Наведите камеру на QR-код"
                  },
                  (result) => {
                      if (!result) {
                          this.scanning = false;
                          return true;
                      }
                      return this.handleScanResult(result);
                  },
              );
          },

          handleScanResult(result) {
              const code = extractCode(result);

              if (!code) {
                  this.showToast("Неверный формат — нужен EAN-8 или EAN-13", "error");
                  TelegramApp.notify("error");
                  tg?.closeScanQrPopup?.();
                  this.scanning = false;
                  return true;
              }

              if (this.codes.has(code)) {
                  this.showToast(`Код ${code} уже добавлен`, "warning");
                  TelegramApp.notify("warning");
                  tg?.closeScanQrPopup?.();
                  this.scanning = false;
                  return true;
              }

              this.addItem(code);
              TelegramApp.notify("success");
              AudioManager.playSuccess();
              this.showToast("Код успешно добавлен", "success");
              tg?.closeScanQrPopup?.();
              this.scanning = false;
              return true;
          },

          addItem(code) {
              this.counter += 1;
              const item = Object.freeze({
                  id: this.counter,
                  code,
                  ts: Date.now(),
              });
              this.codes.add(code);
              this.items.unshift(item);
              this.save();
          },

          renderBarcode(item) {
              const el = document.getElementById(`bc-${item.id}`);
              if (!el || !JsBarcode) return;

              try {
                  JsBarcode(el, item.code, {
                      format: item.code.length === 8 ? "ean8" : "ean13",
                      lineColor: "#1d1d1f",
                      background: "transparent",
                      width: 1.5,
                      height: 56,
                      displayValue: false,
                      margin: 4,
                      flat: true,
                  });
              } catch (err) {
                  console.warn(
                      `[Control] Ошибка рендера штрих-кода: ${item.code}`,
                      err,
                  );
              }
          },

          async copy(code) {
              TelegramApp.haptic("light");
              try {
                  await navigator.clipboard.writeText(code);
                  this.showToast(`${code} скопирован`, "success");
                  TelegramApp.notify("success");
              } catch {
                  this.showToast("Не удалось скопировать код", "error");
              }
          },

          remove(id) {
              TelegramApp.haptic("medium");
              const item = this.items.find((i) => i.id === id);
              if (item) this.codes.delete(item.code);
              this.items = this.items.filter((i) => i.id !== id);
              this.save();
          },

          async confirmClear() {
              TelegramApp.haptic("medium");
              const confirmed = await TelegramApp.confirm(
                  "Удалить все отсканированные коды? Это действие нельзя отменить.",
              );
              if (confirmed) {
                  this.items = [];
                  this.codes.clear();
                  this.counter = 0;
                  this.save();
                  this.showToast("История очищена", "success");
                  TelegramApp.notify("success");
              }
          },

          showToast(message, type = "success") {
              if (this._toastTimer) clearTimeout(this._toastTimer);
              this.toast = {
                  visible: true,
                  message,
                  type
              };
              this._toastTimer = setTimeout(() => {
                  this.toast.visible = false;
                  this._toastTimer = null;
              }, TOAST_DURATION);
          },

          async save() {
              const payload = JSON.stringify({
                  items: this.items,
                  counter: this.counter,
              });
              await TelegramApp.cloudSet(STORAGE_KEY, payload);
          },

          async load() {
              const raw = await TelegramApp.cloudGet(STORAGE_KEY);
              if (!raw) return;

              try {
                  const data = JSON.parse(raw);
                  if (!Array.isArray(data?.items)) return;

                  this.items = data.items;
                  this.counter = data.counter ?? data.items.length;
                  this.codes = new Set(data.items.map((i) => i.code));

                  this.$nextTick(() => {
                      requestAnimationFrame(() => {
                          for (const item of this.items) {
                              this.renderBarcode(item);
                          }
                      });
                  });
              } catch (err) {
                  console.error("[Control] Ошибка загрузки данных:", err);
                  this.showToast("Не удалось загрузить сохранённые данные", "error");
              }
          },
      }));

      Alpine.start();
    </script>
  </body>
</html>
