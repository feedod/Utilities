<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="color-scheme" content="dark" />
    <title>–ó–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</title>

    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://telegram.org" crossorigin />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="importmap">
      {
        "imports": {
          "alpinejs": "https://cdn.jsdelivr.net/npm/alpinejs@3/+esm"
        }
      }
    </script>

    <style type="text/tailwindcss">
      @theme {
        --color-bg: oklch(0% 0 0);
        --color-surface: oklch(12% 0.005 285);
        --color-surface-elevated: oklch(18% 0.008 285);
        --color-surface-tertiary: oklch(24% 0.008 285);
        --color-border: oklch(30% 0.012 285 / 0.5);
        --color-border-subtle: oklch(25% 0.008 285 / 0.4);
        --color-separator: oklch(35% 0.01 285 / 0.35);
        --color-text-primary: oklch(97% 0 0);
        --color-text-secondary: oklch(82% 0.01 285);
        --color-text-tertiary: oklch(62% 0.015 285);
        --color-text-muted: oklch(48% 0.02 285);
        --color-success: oklch(75% 0.18 150);
        --color-error: oklch(68% 0.22 25);
        --color-warning: oklch(80% 0.16 75);
        --color-accent: oklch(68% 0.2 260);
        --color-accent-dim: oklch(68% 0.2 260 / 0.12);
        --color-accent-border: oklch(68% 0.2 260 / 0.25);
        --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
        --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @layer base {
        *,
        *::before,
        *::after {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          -webkit-tap-highlight-color: transparent;
        }

        html {
          background: var(--color-bg);
          color: var(--color-text-primary);
          font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
            "SF Pro Text", system-ui, sans-serif;
          font-feature-settings: "kern" 1, "liga" 1;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          text-rendering: optimizeLegibility;
          scroll-behavior: smooth;
        }

        body {
          min-height: 100dvh;
          overscroll-behavior: none;
          overflow-x: hidden;
          scrollbar-width: none;
          padding: env(safe-area-inset-top) env(safe-area-inset-right)
            calc(env(safe-area-inset-bottom) + 2rem) env(safe-area-inset-left);
        }

        body::-webkit-scrollbar {
          display: none;
        }

        [x-cloak] {
          display: none !important;
        }

        input[type="number"] {
          -moz-appearance: textfield;
          &::-webkit-inner-spin-button,
          &::-webkit-outer-spin-button {
            appearance: none;
            margin: 0;
          }
        }

        @media (prefers-reduced-motion: reduce) {
          *,
          *::before,
          *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
          }
        }
      }

      @layer components {
        .card {
          background: linear-gradient(
            180deg,
            var(--color-surface-elevated) 0%,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 60%,
                var(--color-surface)
              )
              100%
          );
          border: 1px solid var(--color-border);
          border-radius: 1.25rem;
          overflow: hidden;
          transition:
            transform 200ms var(--ease-out-expo),
            box-shadow 200ms var(--ease-out-expo);
        }

        .card-result {
          background: linear-gradient(
            145deg,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 80%,
                oklch(75% 0.18 150)
              )
              0%,
            var(--color-surface-elevated) 100%
          );
          border: 1px solid oklch(75% 0.18 150 / 0.25);
        }

        .card-attestation {
          background: linear-gradient(
            145deg,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 85%,
                oklch(68% 0.2 260)
              )
              0%,
            var(--color-surface-elevated) 100%
          );
          border: 1px solid var(--color-accent-border);
        }

        .input-field {
          width: 100%;
          background: var(--color-surface);
          border: 1px solid var(--color-border-subtle);
          border-radius: 0.875rem;
          padding: 0.75rem 1rem;
          font-size: 1rem;
          font-weight: 500;
          color: var(--color-text-primary);
          outline: none;
          transition:
            border-color 200ms ease,
            box-shadow 200ms ease,
            background 200ms ease;
          font-variant-numeric: tabular-nums;

          &:focus {
            border-color: oklch(68% 0.2 260 / 0.5);
            box-shadow: 0 0 0 3px oklch(68% 0.2 260 / 0.12);
            background: color-mix(
              in oklch,
              var(--color-surface) 90%,
              oklch(68% 0.2 260)
            );
          }

          &::placeholder {
            color: var(--color-text-muted);
            font-weight: 400;
          }
        }

        .formula-input {
          font-family: "SF Mono", Menlo, Monaco, "Courier New", monospace;
          font-size: 0.875rem;
          letter-spacing: 0.02em;
          background: var(--color-bg);
          border: 1.5px solid var(--color-accent-border);
          padding: 1rem 1.25rem;
          border-radius: 1rem;
          min-height: 3.5rem;

          &:focus {
            border-color: oklch(68% 0.2 260 / 0.7);
            box-shadow: 0 0 0 4px oklch(68% 0.2 260 / 0.15);
            background: color-mix(
              in oklch,
              var(--color-bg) 92%,
              oklch(68% 0.2 260)
            );
          }
        }

        .badge {
          display: inline-flex;
          align-items: center;
          gap: 0.375rem;
          padding: 0.4rem 0.9rem;
          font-size: 0.8125rem;
          font-weight: 500;
          border-radius: 9999px;
        }

        .badge-accent {
          background: var(--color-accent-dim);
          border: 1px solid var(--color-accent-border);
          color: var(--color-accent);
        }

        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border: none;
          cursor: pointer;
          transition:
            transform 150ms var(--ease-out-expo),
            opacity 150ms var(--ease-out-expo),
            background 150ms ease;
          user-select: none;

          &:active {
            transform: scale(0.92);
          }
        }

        .btn-primary {
          background: linear-gradient(
            180deg,
            oklch(75% 0.18 150) 0%,
            oklch(65% 0.18 150) 100%
          );
          color: #fff;
          font-weight: 600;
          font-size: 0.9375rem;
          border-radius: 0.875rem;
          padding: 0.875rem 1.5rem;
          box-shadow:
            0 2px 12px oklch(75% 0.18 150 / 0.3),
            inset 0 1px 0 oklch(100% 0 0 / 0.15);
          letter-spacing: 0.01em;

          &:hover {
            box-shadow:
              0 4px 20px oklch(75% 0.18 150 / 0.4),
              inset 0 1px 0 oklch(100% 0 0 / 0.15);
          }
        }

        .btn-secondary {
          background: var(--color-surface-tertiary);
          border: 1px solid var(--color-border);
          color: var(--color-text-secondary);
          font-weight: 500;
          font-size: 0.875rem;
          border-radius: 0.875rem;
          padding: 0.625rem 1rem;

          &:hover {
            background: color-mix(
              in oklch,
              var(--color-surface-tertiary) 80%,
              var(--color-surface-elevated)
            );
          }
        }

        .btn-role {
          background: var(--color-surface);
          border: 1.5px solid var(--color-border-subtle);
          color: var(--color-text-secondary);
          font-weight: 500;
          font-size: 0.875rem;
          border-radius: 0.875rem;
          padding: 0.75rem 1.25rem;
          flex: 1;
          transition:
            transform 150ms var(--ease-out-expo),
            background 200ms ease,
            border-color 200ms ease,
            color 200ms ease,
            box-shadow 200ms ease;

          &.active {
            background: var(--color-accent-dim);
            border-color: oklch(68% 0.2 260 / 0.5);
            color: var(--color-accent);
            box-shadow: 0 0 0 3px oklch(68% 0.2 260 / 0.1);
          }
        }

        .toast {
          background: oklch(14% 0.01 285 / 0.94);
          backdrop-filter: blur(24px) saturate(180%);
          border: 1px solid var(--color-border);
          border-radius: 9999px;
          box-shadow:
            0 8px 32px oklch(0% 0 0 / 0.5),
            inset 0 1px 0 oklch(100% 0 0 / 0.06);
        }

        .empty-state {
          background:
            radial-gradient(
              ellipse at 30% 20%,
              oklch(65% 0.2 260 / 0.06) 0%,
              transparent 60%
            ),
            radial-gradient(
              ellipse at 70% 80%,
              oklch(75% 0.18 150 / 0.04) 0%,
              transparent 60%
            ),
            linear-gradient(
              145deg,
              var(--color-surface) 0%,
              var(--color-surface-elevated) 100%
            );
          border: 1.5px dashed var(--color-border);
          border-radius: 1.75rem;
        }

        .empty-icon {
          background: linear-gradient(
            145deg,
            var(--color-surface-elevated) 0%,
            var(--color-surface-tertiary) 100%
          );
          border-radius: 1.5rem;
          box-shadow:
            inset 0 1px 0 oklch(100% 0 0 / 0.06),
            0 4px 16px oklch(0% 0 0 / 0.2);
        }

        .header-glow {
          background: radial-gradient(
            ellipse 50% 80% at 50% 0%,
            oklch(68% 0.2 260 / 0.08) 0%,
            transparent 100%
          );
        }

        .divider {
          height: 1px;
          background: linear-gradient(
            90deg,
            transparent 0%,
            var(--color-separator) 30%,
            var(--color-separator) 70%,
            transparent 100%
          );
        }

        .result-value {
          font-variant-numeric: tabular-nums;
          font-feature-settings: "tnum" 1;
        }

        .att-card {
          background: var(--color-surface);
          border: 1px solid var(--color-border-subtle);
          border-radius: 1rem;
          padding: 1rem;
          text-align: center;
          transition:
            transform 200ms var(--ease-out-expo),
            border-color 200ms ease,
            box-shadow 200ms ease;

          &:hover {
            border-color: var(--color-accent-border);
            box-shadow: 0 2px 12px oklch(0% 0 0 / 0.2);
          }
        }

        .preset-chip {
          padding: 0.5rem 0.875rem;
          font-size: 0.75rem;
          font-weight: 500;
          border-radius: 9999px;
          background: var(--color-surface);
          border: 1px solid var(--color-border-subtle);
          color: var(--color-text-tertiary);
          cursor: pointer;
          transition:
            transform 150ms var(--ease-out-expo),
            background 150ms ease,
            border-color 150ms ease,
            color 150ms ease;
          white-space: nowrap;

          &:active {
            transform: scale(0.92);
          }

          &:hover {
            background: var(--color-accent-dim);
            border-color: var(--color-accent-border);
            color: var(--color-accent);
          }
        }
      }

      @layer utilities {
        @keyframes fade-in {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes slide-up {
          from {
            opacity: 0;
            transform: translateY(1.25rem);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes count-up {
          from {
            opacity: 0;
            transform: translateY(0.5rem) scale(0.95);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }

        @keyframes shimmer {
          from {
            background-position: -200% center;
          }
          to {
            background-position: 200% center;
          }
        }

        .animate-fade {
          animation: fade-in 350ms var(--ease-out-expo) both;
        }

        .animate-slide {
          animation: slide-up 450ms var(--ease-out-expo) both;
        }

        .animate-count {
          animation: count-up 400ms var(--ease-spring) both;
        }

        .text-balance {
          text-wrap: balance;
        }
      }
    </style>
  </head>

  <body x-cloak x-data="salaryApp" class="flex flex-col select-none">
    <div
      class="header-glow pointer-events-none fixed inset-x-0 top-0 z-0 h-48"
      aria-hidden="true"
    ></div>

    <main
      class="relative z-10 mx-auto flex w-full max-w-md flex-1 flex-col px-4"
      role="main"
    >
      <!-- Header -->
      <header class="animate-fade pb-6 pt-8 text-center">
        <h1 class="text-balance text-3xl font-bold tracking-tight">
          üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞
        </h1>
        <p class="mt-1.5 text-sm text-text-muted">
          –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
        </p>
      </header>

      <div class="flex-1 space-y-4 pb-8">
        <!-- Role Selector -->
        <nav
          class="animate-slide flex gap-3"
          style="animation-delay: 50ms"
          aria-label="–í—ã–±–æ—Ä —Ä–æ–ª–∏"
        >
          <button
            type="button"
            class="btn btn-role"
            :class="{ active: role === 'staff' }"
            :aria-pressed="role === 'staff'"
            @click="setRole('staff')"
          >
            <svg
              class="mr-2 inline-block size-4"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
              />
            </svg>
            –ü–µ—Ä—Å–æ–Ω–∞–ª
          </button>
          <button
            type="button"
            class="btn btn-role"
            :class="{ active: role === 'admin' }"
            :aria-pressed="role === 'admin'"
            @click="setRole('admin')"
          >
            <svg
              class="mr-2 inline-block size-4"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
              />
            </svg>
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
          </button>
        </nav>

        <!-- Formula Card -->
        <section
          class="card animate-slide p-4"
          style="animation-delay: 100ms"
          aria-label="–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞"
        >
          <div class="mb-3 flex items-center gap-2">
            <svg
              class="size-4 text-accent"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M4.745 3A23.933 23.933 0 0 0 3 12c0 3.183.62 6.22 1.745 9M19.5 3c.967 2.78 1.5 5.817 1.5 9s-.533 6.22-1.5 9M8.25 8.885l1.444-.89a.75.75 0 0 1 1.105.402l2.402 7.206a.75.75 0 0 0 1.105.402l1.444-.89"
              />
            </svg>
            <label for="formula-field" class="text-sm font-semibold text-text-secondary">
              –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞
            </label>
          </div>
          <input
            id="formula-field"
            type="text"
            class="input-field formula-input"
            x-model="formula"
            @input="parseFormula()"
            placeholder="–ü—Ä–∏–º–µ—Ä: –æ–∫–ª–∞–¥ + –ø—Ä–µ–º–∏—è_–¢–û + –ø—Ä–µ–º–∏—è_–ú–í–û"
            spellcheck="false"
            autocomplete="off"
            autocapitalize="off"
          />
          <div class="mt-3 flex flex-wrap gap-2" role="group" aria-label="–ü—Ä–µ—Å–µ—Ç—ã —Ñ–æ—Ä–º—É–ª">
            <button
              type="button"
              class="preset-chip"
              @click="applyPreset('default')"
            >
              ‚ö° –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è
            </button>
            <button
              type="button"
              class="preset-chip"
              @click="applyPreset('simple')"
            >
              üìã –¢–æ–ª—å–∫–æ –æ–∫–ª–∞–¥
            </button>
            <button
              type="button"
              class="preset-chip"
              @click="applyPreset('full')"
            >
              üéì –ü–æ–ª–Ω–∞—è —Å –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–µ–π
            </button>
          </div>

          <template x-if="formulaError">
            <p
              class="mt-2.5 flex items-center gap-1.5 text-xs text-error"
              role="alert"
            >
              <svg
                class="size-3.5 shrink-0"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
                />
              </svg>
              <span x-text="formulaError"></span>
            </p>
          </template>

          <template x-if="!formulaError && parsedVars.length > 0">
            <p class="mt-2.5 flex items-center gap-1.5 text-xs text-success">
              <svg
                class="size-3.5 shrink-0"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="m4.5 12.75 6 6 9-13.5"
                />
              </svg>
              <span>
                –ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
                <strong x-text="parsedVars.length"></strong>
              </span>
            </p>
          </template>
        </section>

        <!-- Variables -->
        <template x-if="parsedVars.length > 0">
          <section class="animate-fade space-y-3" aria-label="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞">
            <div class="flex items-center justify-between px-1">
              <div class="badge badge-accent">
                <svg
                  class="size-3.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                  />
                </svg>
                <span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
              </div>
              <button
                type="button"
                class="btn btn-secondary text-xs"
                @click="resetValues()"
              >
                <svg
                  class="mr-1.5 size-3.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182"
                  />
                </svg>
                –°–±—Ä–æ—Å–∏—Ç—å
              </button>
            </div>

            <template x-for="(v, idx) in parsedVars" :key="v">
              <div
                class="card animate-slide p-4"
                :style="`animation-delay: ${Math.min(idx * 60, 300)}ms`"
              >
                <label
                  :for="'var-' + v"
                  class="mb-2 flex items-center gap-2"
                >
                  <span
                    class="inline-flex size-6 items-center justify-center rounded-md text-xs font-bold"
                    :class="getVarColor(v)"
                    x-text="idx + 1"
                    aria-hidden="true"
                  ></span>
                  <span
                    class="text-sm font-medium text-text-secondary"
                    x-text="getVarLabel(v)"
                  ></span>
                  <code
                    class="ml-auto font-mono text-xs text-text-muted"
                    x-text="v"
                  ></code>
                </label>
                <input
                  :id="'var-' + v"
                  type="number"
                  class="input-field"
                  :placeholder="getVarPlaceholder(v)"
                  x-model.number="values[v]"
                  @input="calculate()"
                  inputmode="decimal"
                  step="any"
                />
                <template x-if="getVarHint(v)">
                  <p
                    class="mt-1.5 text-xs text-text-muted"
                    x-text="getVarHint(v)"
                  ></p>
                </template>
              </div>
            </template>
          </section>
        </template>

        <!-- Calculate Button -->
        <template x-if="parsedVars.length > 0">
          <div class="animate-slide pt-1" style="animation-delay: 200ms">
            <button
              type="button"
              class="btn btn-primary w-full"
              @click="calculate()"
            >
              <svg
                class="mr-2 size-5"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V13.5Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V18Zm2.498-6.75h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V13.5Zm0 2.25h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V18Zm2.504-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5Zm0 2.25h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V18Zm2.498-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5ZM8.25 6h7.5v2.25h-7.5V6ZM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 0 0 2.25 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0 0 12 2.25Z"
                />
              </svg>
              –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É
            </button>
          </div>
        </template>

        <!-- Results -->
        <template x-if="result !== null">
          <section class="animate-slide space-y-3 pt-2" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞">
            <div class="divider" aria-hidden="true"></div>

            <!-- Total -->
            <div class="card card-result p-5 text-center">
              <p class="mb-1 text-xs font-medium uppercase tracking-widest text-success">
                –ò—Ç–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ
              </p>
              <p
                class="animate-count result-value text-4xl font-bold text-text-primary"
                x-text="formatMoney(result)"
                aria-live="polite"
              ></p>
              <p class="mt-1.5 text-sm text-text-muted">–±–µ–∑ —É—á—ë—Ç–∞ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏</p>
            </div>

            <!-- Breakdown -->
            <div class="card p-4">
              <div class="mb-3 flex items-center gap-2">
                <svg
                  class="size-4 text-text-tertiary"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z"
                  />
                </svg>
                <span class="text-sm font-semibold text-text-secondary">
                  –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
                </span>
              </div>
              <dl class="space-y-2.5">
                <template x-for="v in parsedVars" :key="'d-' + v">
                  <div class="flex items-center justify-between">
                    <dt
                      class="text-sm text-text-tertiary"
                      x-text="getVarLabel(v)"
                    ></dt>
                    <dd
                      class="result-value text-sm font-semibold text-text-primary"
                      x-text="formatMoney(values[v] || 0)"
                    ></dd>
                  </div>
                </template>
                <div class="divider my-1" aria-hidden="true"></div>
                <div class="flex items-center justify-between">
                  <dt class="text-sm font-semibold text-text-secondary">
                    –°—É–º–º–∞
                  </dt>
                  <dd
                    class="result-value text-sm font-bold text-success"
                    x-text="formatMoney(result)"
                  ></dd>
                </div>
              </dl>
            </div>

            <!-- Attestation -->
            <div class="card card-attestation p-4">
              <div class="mb-3 flex items-center gap-2">
                <svg
                  class="size-4 text-accent"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"
                  />
                </svg>
                <span class="text-sm font-semibold text-text-secondary">
                  –° —É—á—ë—Ç–æ–º –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏
                </span>
              </div>
              <div class="grid grid-cols-2 gap-2.5">
                <template x-for="att in attestations" :key="att.name">
                  <article class="att-card">
                    <p
                      class="mb-1 text-xs font-medium text-text-muted"
                      x-text="att.name"
                    ></p>
                    <p class="mb-1.5 text-xs text-text-tertiary">
                      –ö–ê:
                      <span
                        class="font-semibold text-text-secondary"
                        x-text="att.ka"
                      ></span>
                    </p>
                    <p class="mb-0.5 text-xs text-text-muted">–ü—Ä–µ–º–∏—è</p>
                    <p
                      class="result-value text-sm font-bold text-accent"
                      x-text="formatMoney(att.bonus)"
                    ></p>
                    <div class="divider my-2" aria-hidden="true"></div>
                    <p class="mb-0.5 text-xs text-text-muted">–ò—Ç–æ–≥–æ</p>
                    <p
                      class="result-value text-lg font-bold text-text-primary"
                      x-text="formatMoney(att.total)"
                    ></p>
                  </article>
                </template>
              </div>
            </div>
          </section>
        </template>

        <!-- Empty State -->
        <template x-if="parsedVars.length === 0 && !formula">
          <div class="animate-slide">
            <div
              class="empty-state flex flex-col items-center px-6 py-12 text-center"
            >
              <div
                class="empty-icon mb-6 flex size-20 items-center justify-center"
              >
                <svg
                  class="size-10 text-text-muted"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V13.5Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V18Zm2.498-6.75h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V13.5Zm0 2.25h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V18Zm2.504-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5Zm0 2.25h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V18Zm2.498-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5ZM8.25 6h7.5v2.25h-7.5V6ZM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 0 0 2.25 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0 0 12 2.25Z"
                  />
                </svg>
              </div>
              <h2 class="text-balance text-xl font-semibold text-text-primary">
                –í–≤–µ–¥–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É
              </h2>
              <p class="mt-3 max-w-[17rem] text-sm leading-relaxed text-text-muted">
                –ù–∞–ø–∏—à–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É —Ä–∞—Å—á—ë—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã –≤—ã—à–µ, –∏ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞
                —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
              </p>
              <div class="mt-7 flex items-center gap-2 text-xs font-medium text-text-tertiary">
                <svg
                  class="size-4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"
                  />
                </svg>
                <span>–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–µ—Å–µ—Ç –≤—ã—à–µ</span>
              </div>
            </div>
          </div>
        </template>
      </div>
    </main>

    <!-- Toast -->
    <div
      x-show="toast.visible"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 translate-y-4 scale-95"
      x-transition:enter-end="opacity-100 translate-y-0 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 translate-y-0 scale-100"
      x-transition:leave-end="opacity-0 translate-y-4 scale-95"
      class="toast fixed bottom-8 left-1/2 z-50 -translate-x-1/2 px-5 py-3"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
      <div class="flex items-center gap-2.5 whitespace-nowrap">
        <template x-if="toast.type === 'success'">
          <svg
            class="size-5 text-success"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m4.5 12.75 6 6 9-13.5"
            />
          </svg>
        </template>
        <template x-if="toast.type === 'error'">
          <svg
            class="size-5 text-error"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
            />
          </svg>
        </template>
        <span
          class="text-sm font-medium text-text-primary"
          x-text="toast.message"
        ></span>
      </div>
    </div>

    <script type="module">
      import Alpine from "alpinejs";

      /* ‚îÄ‚îÄ‚îÄ Telegram WebApp Integration ‚îÄ‚îÄ‚îÄ */

      const tg = globalThis.Telegram?.WebApp;

      const TelegramApp = Object.freeze({
        init() {
          if (!tg) return;
          tg.ready();
          tg.requestFullscreen?.();
          tg.disableVerticalSwipes?.();
          tg.setHeaderColor?.("#000000");
          tg.setBackgroundColor?.("#000000");
          tg.setBottomBarColor?.("#0a0a0a");
        },
        haptic(type = "light") {
          tg?.HapticFeedback?.impactOccurred?.(type);
        },
        notify(type = "success") {
          tg?.HapticFeedback?.notificationOccurred?.(type);
        },
      });

      /* ‚îÄ‚îÄ‚îÄ Safe Math Evaluator (no eval) ‚îÄ‚îÄ‚îÄ */

      const TOKEN_TYPE = Object.freeze({
        NUMBER: 0,
        VAR: 1,
        OP: 2,
        LPAREN: 3,
        RPAREN: 4,
      });

      const OPERATORS = new Set(["+", "-", "*", "/"]);
      const VAR_CHAR_RE = /[a-zA-Z–∞-—è–ê-–Ø—ë–Å_0-9]/;
      const VAR_START_RE = /[a-zA-Z–∞-—è–ê-–Ø—ë–Å_]/;

      function tokenize(expr) {
        const tokens = [];
        const s = expr.replaceAll(/\s+/g, "");
        let i = 0;

        while (i < s.length) {
          const ch = s[i];

          // Numbers (including decimals)
          if (ch >= "0" && ch <= "9" || (ch === "." && s[i + 1] >= "0" && s[i + 1] <= "9")) {
            let num = "";
            let hasDot = false;
            while (i < s.length && ((s[i] >= "0" && s[i] <= "9") || (s[i] === "." && !hasDot))) {
              if (s[i] === ".") hasDot = true;
              num += s[i++];
            }
            tokens.push({ type: TOKEN_TYPE.NUMBER, value: +num });
            continue;
          }

          // Operators
          if (OPERATORS.has(ch)) {
            tokens.push({ type: TOKEN_TYPE.OP, value: ch });
            i++;
            continue;
          }

          // Parentheses
          if (ch === "(") {
            tokens.push({ type: TOKEN_TYPE.LPAREN });
            i++;
            continue;
          }
          if (ch === ")") {
            tokens.push({ type: TOKEN_TYPE.RPAREN });
            i++;
            continue;
          }

          // Variables
          if (VAR_START_RE.test(ch)) {
            let name = "";
            while (i < s.length && VAR_CHAR_RE.test(s[i])) {
              name += s[i++];
            }
            tokens.push({ type: TOKEN_TYPE.VAR, value: name });
            continue;
          }

          // Skip unknown characters
          i++;
        }

        return tokens;
      }

      function precedence(op) {
        return op === "+" || op === "-" ? 1 : op === "*" || op === "/" ? 2 : 0;
      }

      function toRPN(tokens) {
        const output = [];
        const ops = [];

        for (const t of tokens) {
          switch (t.type) {
            case TOKEN_TYPE.NUMBER:
            case TOKEN_TYPE.VAR:
              output.push(t);
              break;

            case TOKEN_TYPE.LPAREN:
              ops.push(t);
              break;

            case TOKEN_TYPE.RPAREN:
              while (ops.length && ops.at(-1).type !== TOKEN_TYPE.LPAREN) {
                output.push(ops.pop());
              }
              ops.pop(); // Remove LPAREN
              break;

            case TOKEN_TYPE.OP:
              while (
                ops.length &&
                ops.at(-1).type === TOKEN_TYPE.OP &&
                precedence(ops.at(-1).value) >= precedence(t.value)
              ) {
                output.push(ops.pop());
              }
              ops.push(t);
              break;
          }
        }

        while (ops.length) output.push(ops.pop());
        return output;
      }

      function evalRPN(rpn, variables) {
        const stack = [];

        for (const t of rpn) {
          if (t.type === TOKEN_TYPE.NUMBER) {
            stack.push(t.value);
            continue;
          }

          if (t.type === TOKEN_TYPE.VAR) {
            const val = variables[t.value];
            stack.push(Number.isFinite(val) ? val : 0);
            continue;
          }

          // Operator
          const b = stack.pop() ?? 0;
          const a = stack.pop() ?? 0;

          switch (t.value) {
            case "+": stack.push(a + b); break;
            case "-": stack.push(a - b); break;
            case "*": stack.push(a * b); break;
            case "/": stack.push(b !== 0 ? a / b : 0); break;
          }
        }

        return stack[0] ?? 0;
      }

      function safeEvaluate(expression, variables) {
        return evalRPN(toRPN(tokenize(expression)), variables);
      }

      function extractVariables(expression) {
        const tokens = tokenize(expression);
        const seen = new Set();
        const vars = [];

        for (const t of tokens) {
          if (t.type === TOKEN_TYPE.VAR && !seen.has(t.value)) {
            seen.add(t.value);
            vars.push(t.value);
          }
        }

        return vars;
      }

      /* ‚îÄ‚îÄ‚îÄ Metadata ‚îÄ‚îÄ‚îÄ */

      const VAR_META = Object.freeze({
        –æ–∫–ª–∞–¥: {
          label: "–û–∫–ª–∞–¥ –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é",
          hint: "–°—Ç–∞–≤–∫–∞ √ó –û—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã",
          placeholder: "54264",
          color: "bg-accent/20 text-accent",
        },
        –ø—Ä–µ–º–∏—è_–¢–û: {
          label: "–ü—Ä–µ–º–∏—è –æ—Ç –¢–û",
          hint: "–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ç–æ–≤–∞—Ä–æ–æ–±–æ—Ä–æ—Ç–∞",
          placeholder: "8867",
          color: "bg-success/20 text-success",
        },
        –ø—Ä–µ–º–∏—è_–ú–í–û: {
          label: "–ü—Ä–µ–º–∏—è –ú–í–û",
          hint: "–ù–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ú–í–û",
          placeholder: "35712",
          color: "bg-warning/20 text-warning",
        },
        –¢–û: {
          label: "–¢–û —Ñ–∞–∫—Ç –∑–∞ –º–µ—Å—è—Ü",
          hint: "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ç–æ–≤–∞—Ä–æ–æ–±–æ—Ä–æ—Ç",
          placeholder: "5364677",
          color: "bg-accent/20 text-accent",
        },
        –ú–í–û: {
          label: "–ú–í–û –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ %",
          hint: "–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ú–í–û",
          placeholder: "96",
          color: "bg-warning/20 text-warning",
        },
        —à—Ç–∞—Ç: {
          label: "–®—Ç–∞—Ç –±–µ–∑ –∞–¥–º–∏–Ω–∞",
          hint: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
          placeholder: "4",
          color: "bg-text-tertiary/20 text-text-tertiary",
        },
        –ø–ª–∞–Ω_—á–∞—Å—ã: {
          label: "–ü–ª–∞–Ω–æ–≤–æ–µ –∫–æ–ª-–≤–æ —á–∞—Å–æ–≤",
          hint: "–ü–ª–∞–Ω–æ–≤—ã–µ —á–∞—Å—ã –Ω–∞ –º–µ—Å—è—Ü",
          placeholder: "720",
          color: "bg-text-tertiary/20 text-text-tertiary",
        },
        —Ñ–∞–∫—Ç_—á–∞—Å—ã: {
          label: "–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã",
          hint: "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ",
          placeholder: "238",
          color: "bg-accent/20 text-accent",
        },
        —Å—Ç–∞–≤–∫–∞: {
          label: "–°—Ç–∞–≤–∫–∞ –∑–∞ —á–∞—Å",
          hint: "–û–ø–ª–∞—Ç–∞ –∑–∞ 1 —á–∞—Å —Ä–∞–±–æ—Ç—ã",
          placeholder: "228",
          color: "bg-success/20 text-success",
        },
        –ú–í–û_–ø—Ä–æ—Ü–µ–Ω—Ç: {
          label: "–ú–í–û –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–π %",
          hint: "–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –ú–í–û",
          placeholder: "31",
          color: "bg-warning/20 text-warning",
        },
        salary: {
          label: "–û–∫–ª–∞–¥",
          placeholder: "54264",
          color: "bg-accent/20 text-accent",
        },
        bonus: {
          label: "–ü—Ä–µ–º–∏—è",
          placeholder: "10000",
          color: "bg-success/20 text-success",
        },
        hours: {
          label: "–ß–∞—Å—ã",
          placeholder: "238",
          color: "bg-warning/20 text-warning",
        },
        rate: {
          label: "–°—Ç–∞–≤–∫–∞",
          placeholder: "228",
          color: "bg-accent/20 text-accent",
        },
      });

      const COLORS = Object.freeze([
        "bg-accent/20 text-accent",
        "bg-success/20 text-success",
        "bg-warning/20 text-warning",
        "bg-error/20 text-error",
        "bg-text-tertiary/20 text-text-tertiary",
      ]);

      const PRESETS = Object.freeze({
        default: "–æ–∫–ª–∞–¥ + –ø—Ä–µ–º–∏—è_–¢–û + –ø—Ä–µ–º–∏—è_–ú–í–û",
        simple: "—Å—Ç–∞–≤–∫–∞ * —Ñ–∞–∫—Ç_—á–∞—Å—ã",
        full: "–æ–∫–ª–∞–¥ + –ø—Ä–µ–º–∏—è_–¢–û + –ø—Ä–µ–º–∏—è_–ú–í–û",
      });

      const ATTESTATION = Object.freeze({
        staff: [
          { name: "–ë–µ–∑ –ê—Ç—Ç", ka: 0 },
          { name: "1 –ê—Ç—Ç", ka: 0.25 },
          { name: "2 –ê—Ç—Ç", ka: 0.85 },
          { name: "3 –ê—Ç—Ç", ka: 1.6 },
        ],
        admin: [
          { name: "–ë–µ–∑ –ê—Ç—Ç", ka: 0 },
          { name: "1 –ê—Ç—Ç", ka: 0.5 },
          { name: "2 –ê—Ç—Ç", ka: 1 },
          { name: "3 –ê—Ç—Ç", ka: 1.5 },
        ],
      });

      const FORBIDDEN_CHARS_RE = /[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_+\-*/().\s]/;

      const moneyFormatter = new Intl.NumberFormat("ru-RU", {
        style: "decimal",
        maximumFractionDigits: 0,
      });

      function roundCents(n) {
        return Math.round(n * 100) / 100;
      }

      /* ‚îÄ‚îÄ‚îÄ Alpine App ‚îÄ‚îÄ‚îÄ */

      Alpine.data("salaryApp", () => ({
        role: "staff",
        formula: "",
        formulaError: "",
        parsedVars: [],
        values: {},
        result: null,
        attestations: [],
        toast: { visible: false, message: "", type: "success" },
        _toastTimer: 0,

        init() {
          TelegramApp.init();
          this.applyPreset("default");
        },

        destroy() {
          clearTimeout(this._toastTimer);
        },

        setRole(r) {
          if (this.role === r) return;
          TelegramApp.haptic("light");
          this.role = r;
          if (this.result !== null) this.calculate();
        },

        applyPreset(key) {
          TelegramApp.haptic("light");
          this.formula = PRESETS[key] ?? "";
          this.parseFormula();
          this.showToast("–ü—Ä–µ—Å–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω", "success");
        },

        parseFormula() {
          this.formulaError = "";
          this.result = null;
          this.attestations = [];

          const f = this.formula.trim();

          if (!f) {
            this.parsedVars = [];
            return;
          }

          if (FORBIDDEN_CHARS_RE.test(f)) {
            this.formulaError = "–§–æ—Ä–º—É–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã";
            this.parsedVars = [];
            return;
          }

          // Validate balanced parentheses
          let depth = 0;
          for (const ch of f) {
            if (ch === "(") depth++;
            else if (ch === ")") depth--;
            if (depth < 0) break;
          }

          if (depth !== 0) {
            this.formulaError = "–ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å–∫–æ–±–∫–∏ –≤ —Ñ–æ—Ä–º—É–ª–µ";
            this.parsedVars = [];
            return;
          }

          const vars = extractVariables(f);

          if (vars.length === 0) {
            this.formulaError = "–§–æ—Ä–º—É–ª–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö";
            this.parsedVars = [];
            return;
          }

          const oldValues = { ...this.values };
          this.values = Object.fromEntries(
            vars.map((v) => [v, oldValues[v] ?? null])
          );
          this.parsedVars = vars;
        },

        calculate() {
          TelegramApp.haptic("light");

          const vars = Object.fromEntries(
            this.parsedVars.map((v) => [
              v,
              Number.isFinite(this.values[v]) ? this.values[v] : 0,
            ])
          );

          const res = safeEvaluate(this.formula, vars);
          this.result = roundCents(res);

          const premiaTO = vars["–ø—Ä–µ–º–∏—è_–¢–û"] || this.result * 0.15;
          const attData = ATTESTATION[this.role] ?? ATTESTATION.staff;

          this.attestations = attData.map(({ name, ka }) => {
            const bonus = roundCents(premiaTO * ka);
            return {
              name,
              ka,
              bonus,
              total: roundCents(this.result + bonus),
            };
          });

          TelegramApp.notify("success");
        },

        resetValues() {
          TelegramApp.haptic("medium");

          for (const v of this.parsedVars) {
            this.values[v] = null;
          }

          this.result = null;
          this.attestations = [];
          this.showToast("–ó–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã", "success");
        },

        getVarLabel(v) {
          return VAR_META[v]?.label ?? v.replaceAll("_", " ");
        },

        getVarPlaceholder(v) {
          return VAR_META[v]?.placeholder ?? "0";
        },

        getVarHint(v) {
          return VAR_META[v]?.hint ?? null;
        },

        getVarColor(v) {
          return (
            VAR_META[v]?.color ??
            COLORS[this.parsedVars.indexOf(v) % COLORS.length]
          );
        },

        formatMoney(value) {
          if (!Number.isFinite(value)) return "0 ‚ÇΩ";
          return moneyFormatter.format(Math.round(value)) + " ‚ÇΩ";
        },

        showToast(message, type = "success") {
          clearTimeout(this._toastTimer);
          this.toast = { visible: true, message, type };
          this._toastTimer = setTimeout(() => {
            this.toast.visible = false;
          }, 2500);
        },
      }));

      Alpine.start();
    </script>
  </body>
</html>