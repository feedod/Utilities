<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="color-scheme" content="dark" />

    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://telegram.org" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="importmap">
      {
        "imports": {
          "alpinejs": "https://cdn.jsdelivr.net/npm/alpinejs@3/+esm"
        }
      }
    </script>

    <style type="text/tailwindcss">
      @theme {
        --color-bg: oklch(0% 0 0);
        --color-surface: oklch(12% 0.005 285);
        --color-surface-elevated: oklch(18% 0.008 285);
        --color-surface-tertiary: oklch(24% 0.008 285);
        --color-border: oklch(30% 0.012 285 / 0.5);
        --color-border-subtle: oklch(25% 0.008 285 / 0.4);
        --color-separator: oklch(35% 0.01 285 / 0.35);
        --color-text-primary: oklch(97% 0 0);
        --color-text-secondary: oklch(82% 0.01 285);
        --color-text-tertiary: oklch(62% 0.015 285);
        --color-text-muted: oklch(48% 0.02 285);
        --color-success: oklch(75% 0.18 150);
        --color-error: oklch(68% 0.22 25);
        --color-warning: oklch(80% 0.16 75);
        --color-accent: oklch(68% 0.2 260);
        --color-accent-dim: oklch(68% 0.2 260 / 0.12);
        --color-accent-border: oklch(68% 0.2 260 / 0.25);
        --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
        --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @layer base {
        *,
        *::before,
        *::after {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          -webkit-tap-highlight-color: transparent;
        }

        html {
          background: var(--color-bg);
          color: var(--color-text-primary);
          font-family:
            -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
            system-ui, sans-serif;
          font-feature-settings:
            "kern" 1,
            "liga" 1;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          text-rendering: optimizeLegibility;
          scroll-behavior: smooth;
        }

        body {
          min-height: 100dvh;
          overscroll-behavior: none;
          overflow-x: hidden;
          scrollbar-width: none;
          padding: env(safe-area-inset-top) env(safe-area-inset-right)
            calc(env(safe-area-inset-bottom) + 2rem) env(safe-area-inset-left);
        }

        body::-webkit-scrollbar {
          display: none;
        }

        [x-cloak] {
          display: none !important;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        input[type="number"] {
          -moz-appearance: textfield;
        }

        @media (prefers-reduced-motion: reduce) {
          *,
          *::before,
          *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
          }
        }
      }

      @layer components {
        .card {
          background: linear-gradient(
            180deg,
            var(--color-surface-elevated) 0%,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 60%,
                var(--color-surface)
              )
              100%
          );
          border: 1px solid var(--color-border);
          border-radius: 1.25rem;
          overflow: hidden;
          transition:
            transform 200ms var(--ease-out-expo),
            box-shadow 200ms var(--ease-out-expo);
        }

        .card:hover {
          box-shadow: 0 2px 20px oklch(0% 0 0 / 0.3);
        }

        .card-result {
          background: linear-gradient(
            145deg,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 80%,
                oklch(75% 0.18 150)
              )
              0%,
            var(--color-surface-elevated) 100%
          );
          border: 1px solid oklch(75% 0.18 150 / 0.25);
        }

        .card-attestation {
          background: linear-gradient(
            145deg,
            color-mix(
                in oklch,
                var(--color-surface-elevated) 85%,
                oklch(68% 0.2 260)
              )
              0%,
            var(--color-surface-elevated) 100%
          );
          border: 1px solid var(--color-accent-border);
        }

        .input-field {
          width: 100%;
          background: var(--color-surface);
          border: 1px solid var(--color-border-subtle);
          border-radius: 0.875rem;
          padding: 0.75rem 1rem;
          font-size: 1rem;
          font-weight: 500;
          color: var(--color-text-primary);
          outline: none;
          transition:
            border-color 200ms ease,
            box-shadow 200ms ease,
            background 200ms ease;
          font-variant-numeric: tabular-nums;
        }

        .input-field:focus {
          border-color: oklch(68% 0.2 260 / 0.5);
          box-shadow: 0 0 0 3px oklch(68% 0.2 260 / 0.12);
          background: color-mix(
            in oklch,
            var(--color-surface) 90%,
            oklch(68% 0.2 260)
          );
        }

        .input-field::placeholder {
          color: var(--color-text-muted);
          font-weight: 400;
        }

        .formula-input {
          font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
          font-size: 0.875rem;
          letter-spacing: 0.02em;
          background: var(--color-bg);
          border: 1.5px solid var(--color-accent-border);
          padding: 1rem 1.25rem;
          border-radius: 1rem;
          min-height: 3.5rem;
        }

        .formula-input:focus {
          border-color: oklch(68% 0.2 260 / 0.7);
          box-shadow: 0 0 0 4px oklch(68% 0.2 260 / 0.15);
          background: color-mix(
            in oklch,
            var(--color-bg) 92%,
            oklch(68% 0.2 260)
          );
        }

        .badge {
          display: inline-flex;
          align-items: center;
          gap: 0.375rem;
          padding: 0.4rem 0.9rem;
          font-size: 0.8125rem;
          font-weight: 500;
          border-radius: 9999px;
          background: var(--color-surface-elevated);
          border: 1px solid var(--color-border-subtle);
          color: var(--color-text-secondary);
        }

        .badge-accent {
          background: var(--color-accent-dim);
          border-color: var(--color-accent-border);
          color: var(--color-accent);
        }

        .badge-success {
          background: oklch(75% 0.18 150 / 0.1);
          border-color: oklch(75% 0.18 150 / 0.25);
          color: var(--color-success);
        }

        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border: none;
          cursor: pointer;
          transition:
            transform 150ms var(--ease-out-expo),
            opacity 150ms var(--ease-out-expo),
            background 150ms ease;
          user-select: none;
        }

        .btn:active {
          transform: scale(0.92);
        }

        .btn-primary {
          background: linear-gradient(
            180deg,
            oklch(75% 0.18 150) 0%,
            oklch(65% 0.18 150) 100%
          );
          color: #fff;
          font-weight: 600;
          font-size: 0.9375rem;
          border-radius: 0.875rem;
          padding: 0.875rem 1.5rem;
          box-shadow:
            0 2px 12px oklch(75% 0.18 150 / 0.3),
            inset 0 1px 0 oklch(100% 0 0 / 0.15);
        }

        .btn-primary:hover {
          box-shadow:
            0 4px 20px oklch(75% 0.18 150 / 0.4),
            inset 0 1px 0 oklch(100% 0 0 / 0.15);
        }

        .btn-secondary {
          background: var(--color-surface-tertiary);
          border: 1px solid var(--color-border);
          color: var(--color-text-secondary);
          font-weight: 500;
          font-size: 0.875rem;
          border-radius: 0.875rem;
          padding: 0.625rem 1rem;
        }

        .btn-secondary:hover {
          background: color-mix(
            in oklch,
            var(--color-surface-tertiary) 80%,
            var(--color-surface-elevated)
          );
        }

        .btn-role {
          background: var(--color-surface);
          border: 1.5px solid var(--color-border-subtle);
          color: var(--color-text-secondary);
          font-weight: 500;
          font-size: 0.875rem;
          border-radius: 0.875rem;
          padding: 0.75rem 1.25rem;
          flex: 1;
          transition:
            transform 150ms var(--ease-out-expo),
            background 200ms ease,
            border-color 200ms ease,
            color 200ms ease,
            box-shadow 200ms ease;
        }

        .btn-role.active {
          background: var(--color-accent-dim);
          border-color: oklch(68% 0.2 260 / 0.5);
          color: var(--color-accent);
          box-shadow: 0 0 0 3px oklch(68% 0.2 260 / 0.1);
        }

        .toast {
          background: oklch(14% 0.01 285 / 0.94);
          backdrop-filter: blur(24px) saturate(180%);
          -webkit-backdrop-filter: blur(24px) saturate(180%);
          border: 1px solid var(--color-border);
          border-radius: 9999px;
          box-shadow:
            0 8px 32px oklch(0% 0 0 / 0.5),
            inset 0 1px 0 oklch(100% 0 0 / 0.06);
        }

        .empty-state {
          background:
            radial-gradient(
              ellipse at 30% 20%,
              oklch(65% 0.2 260 / 0.06) 0%,
              transparent 60%
            ),
            radial-gradient(
              ellipse at 70% 80%,
              oklch(75% 0.18 150 / 0.04) 0%,
              transparent 60%
            ),
            linear-gradient(
              145deg,
              var(--color-surface) 0%,
              var(--color-surface-elevated) 100%
            );
          border: 1.5px dashed var(--color-border);
          border-radius: 1.75rem;
        }

        .empty-icon {
          background: linear-gradient(
            145deg,
            var(--color-surface-elevated) 0%,
            var(--color-surface-tertiary) 100%
          );
          border-radius: 1.5rem;
          box-shadow:
            inset 0 1px 0 oklch(100% 0 0 / 0.06),
            0 4px 16px oklch(0% 0 0 / 0.2);
        }

        .header-glow {
          background: radial-gradient(
            ellipse 50% 80% at 50% 0%,
            oklch(68% 0.2 260 / 0.08) 0%,
            transparent 100%
          );
        }

        .divider {
          height: 1px;
          background: linear-gradient(
            90deg,
            transparent 0%,
            var(--color-separator) 30%,
            var(--color-separator) 70%,
            transparent 100%
          );
        }

        .result-value {
          font-variant-numeric: tabular-nums;
          font-feature-settings: "tnum" 1;
        }

        .att-card {
          background: var(--color-surface);
          border: 1px solid var(--color-border-subtle);
          border-radius: 1rem;
          padding: 1rem;
          text-align: center;
          transition:
            transform 200ms var(--ease-out-expo),
            border-color 200ms ease,
            box-shadow 200ms ease;
        }

        .att-card:hover {
          border-color: var(--color-accent-border);
          box-shadow: 0 2px 12px oklch(0% 0 0 / 0.2);
        }

        .preset-chip {
          padding: 0.5rem 0.875rem;
          font-size: 0.75rem;
          font-weight: 500;
          border-radius: 9999px;
          background: var(--color-surface);
          border: 1px solid var(--color-border-subtle);
          color: var(--color-text-tertiary);
          cursor: pointer;
          transition:
            transform 150ms var(--ease-out-expo),
            background 150ms ease,
            border-color 150ms ease,
            color 150ms ease;
          white-space: nowrap;
        }

        .preset-chip:active {
          transform: scale(0.92);
        }

        .preset-chip:hover {
          background: var(--color-accent-dim);
          border-color: var(--color-accent-border);
          color: var(--color-accent);
        }
      }

      @layer utilities {
        @keyframes fade-in {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes slide-up {
          from {
            opacity: 0;
            transform: translateY(1.25rem);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes count-up {
          from {
            opacity: 0;
            transform: translateY(0.5rem);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .animate-fade {
          animation: fade-in 350ms var(--ease-out-expo) forwards;
        }

        .animate-slide {
          animation: slide-up 450ms var(--ease-out-expo) forwards;
        }

        .animate-count {
          animation: count-up 300ms var(--ease-out-expo) forwards;
        }

        .text-balance {
          text-wrap: balance;
        }
      }
    </style>
  </head>

  <body x-cloak x-data="salaryApp" class="flex flex-col select-none">
    <div
      class="header-glow pointer-events-none fixed inset-x-0 top-0 z-0 h-48"
      aria-hidden="true"
    ></div>

    <main
      class="relative z-10 mx-auto flex w-full max-w-md flex-1 flex-col px-4"
    >
      <header class="animate-fade pb-6 pt-8 text-center">
        <h1 class="text-balance text-3xl font-bold tracking-tight">Зарплата</h1>
        <p class="mt-1.5 text-sm text-text-muted">Калькулятор начислений</p>
      </header>

      <div class="flex-1 space-y-4 pb-8">
        <div class="animate-slide flex gap-3" style="animation-delay: 50ms">
          <button
            type="button"
            class="btn btn-role"
            :class="{ active: role === 'staff' }"
            @click="setRole('staff')"
          >
            <svg
              class="mr-2 h-4 w-4 inline-block"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
              />
            </svg>
            Персонал
          </button>
          <button
            type="button"
            class="btn btn-role"
            :class="{ active: role === 'admin' }"
            @click="setRole('admin')"
          >
            <svg
              class="mr-2 h-4 w-4 inline-block"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
              />
            </svg>
            Администратор
          </button>
        </div>

        <div class="card animate-slide p-4" style="animation-delay: 100ms">
          <div class="mb-3 flex items-center gap-2">
            <svg
              class="h-4 w-4 text-accent"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M4.745 3A23.933 23.933 0 0 0 3 12c0 3.183.62 6.22 1.745 9M19.5 3c.967 2.78 1.5 5.817 1.5 9s-.533 6.22-1.5 9M8.25 8.885l1.444-.89a.75.75 0 0 1 1.105.402l2.402 7.206a.75.75 0 0 0 1.105.402l1.444-.89"
              />
            </svg>
            <span class="text-sm font-semibold text-text-secondary"
              >Формула расчёта</span
            >
          </div>
          <input
            type="text"
            class="input-field formula-input"
            x-model="formula"
            @input="parseFormula()"
            placeholder="Пример: оклад + премия_ТО + премия_МВО"
            spellcheck="false"
            autocomplete="off"
          />
          <div class="mt-3 flex flex-wrap gap-2">
            <button
              type="button"
              class="preset-chip"
              @click="applyPreset('default')"
            >
              Стандартная
            </button>
            <button
              type="button"
              class="preset-chip"
              @click="applyPreset('simple')"
            >
              Только оклад
            </button>
            <button
              type="button"
              class="preset-chip"
              @click="applyPreset('full')"
            >
              Полная с аттестацией
            </button>
          </div>
          <template x-if="formulaError">
            <p class="mt-2.5 flex items-center gap-1.5 text-xs text-error">
              <svg
                class="h-3.5 w-3.5 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
                />
              </svg>
              <span x-text="formulaError"></span>
            </p>
          </template>
          <template x-if="!formulaError && parsedVars.length > 0">
            <p class="mt-2.5 flex items-center gap-1.5 text-xs text-success">
              <svg
                class="h-3.5 w-3.5 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="m4.5 12.75 6 6 9-13.5"
                />
              </svg>
              <span
                >Найдено переменных: <strong x-text="parsedVars.length"></strong
              ></span>
            </p>
          </template>
        </div>

        <template x-if="parsedVars.length > 0">
          <div class="animate-fade space-y-3">
            <div class="flex items-center justify-between px-1">
              <div class="badge badge-accent">
                <svg
                  class="h-3.5 w-3.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                  />
                </svg>
                <span>Ввод данных</span>
              </div>
              <button
                type="button"
                class="btn btn-secondary text-xs"
                @click="resetValues()"
              >
                <svg
                  class="mr-1.5 h-3.5 w-3.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182"
                  />
                </svg>
                Сбросить
              </button>
            </div>

            <template x-for="(v, idx) in parsedVars" :key="v">
              <div
                class="card animate-slide p-4"
                :style="`animation-delay: ${Math.min(idx * 60, 300)}ms`"
              >
                <label class="mb-2 flex items-center gap-2">
                  <span
                    class="inline-flex h-6 w-6 items-center justify-center rounded-md text-xs font-bold"
                    :class="getVarColor(v)"
                    x-text="(idx + 1)"
                  ></span>
                  <span
                    class="text-sm font-medium text-text-secondary"
                    x-text="getVarLabel(v)"
                  ></span>
                  <span
                    class="ml-auto font-mono text-xs text-text-muted"
                    x-text="v"
                  ></span>
                </label>
                <input
                  type="number"
                  class="input-field"
                  :placeholder="getVarPlaceholder(v)"
                  x-model.number="values[v]"
                  @input="calculate()"
                  inputmode="decimal"
                  step="any"
                />
                <template x-if="getVarHint(v)">
                  <p
                    class="mt-1.5 text-xs text-text-muted"
                    x-text="getVarHint(v)"
                  ></p>
                </template>
              </div>
            </template>
          </div>
        </template>

        <template x-if="parsedVars.length > 0">
          <div class="animate-slide pt-1" style="animation-delay: 200ms">
            <button
              type="button"
              class="btn btn-primary w-full"
              @click="calculate()"
            >
              <svg
                class="mr-2 h-5 w-5"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V13.5Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V18Zm2.498-6.75h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V13.5Zm0 2.25h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V18Zm2.504-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5Zm0 2.25h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V18Zm2.498-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5ZM8.25 6h7.5v2.25h-7.5V6ZM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 0 0 2.25 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0 0 12 2.25Z"
                />
              </svg>
              Рассчитать зарплату
            </button>
          </div>
        </template>

        <template x-if="result !== null">
          <div class="animate-slide space-y-3 pt-2">
            <div class="divider"></div>

            <div class="card card-result p-5 text-center">
              <p
                class="mb-1 text-xs font-medium uppercase tracking-widest text-success"
              >
                Итого начислено
              </p>
              <p
                class="animate-count result-value text-4xl font-bold text-text-primary"
                x-text="formatMoney(result)"
              ></p>
              <p class="mt-1.5 text-sm text-text-muted">без учёта аттестации</p>
            </div>

            <div class="card p-4">
              <div class="mb-3 flex items-center gap-2">
                <svg
                  class="h-4 w-4 text-text-tertiary"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z"
                  />
                </svg>
                <span class="text-sm font-semibold text-text-secondary"
                  >Детализация</span
                >
              </div>
              <div class="space-y-2.5">
                <template x-for="(v, idx) in parsedVars" :key="'d-'+v">
                  <div class="flex items-center justify-between">
                    <span
                      class="text-sm text-text-tertiary"
                      x-text="getVarLabel(v)"
                    ></span>
                    <span
                      class="result-value text-sm font-semibold text-text-primary"
                      x-text="formatMoney(values[v] || 0)"
                    ></span>
                  </div>
                </template>
                <div class="divider my-1"></div>
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold text-text-secondary"
                    >Сумма</span
                  >
                  <span
                    class="result-value text-sm font-bold text-success"
                    x-text="formatMoney(result)"
                  ></span>
                </div>
              </div>
            </div>

            <div class="card card-attestation p-4">
              <div class="mb-3 flex items-center gap-2">
                <svg
                  class="h-4 w-4 text-accent"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"
                  />
                </svg>
                <span class="text-sm font-semibold text-text-secondary"
                  >С учётом аттестации</span
                >
              </div>
              <div class="grid grid-cols-2 gap-2.5">
                <template x-for="att in attestations" :key="att.name">
                  <div class="att-card">
                    <p
                      class="mb-1 text-xs font-medium text-text-muted"
                      x-text="att.name"
                    ></p>
                    <p class="text-xs text-text-tertiary mb-1.5">
                      КА:
                      <span
                        class="font-semibold text-text-secondary"
                        x-text="att.ka"
                      ></span>
                    </p>
                    <p class="text-xs text-text-muted mb-0.5">Премия</p>
                    <p
                      class="result-value text-sm font-bold text-accent"
                      x-text="formatMoney(att.bonus)"
                    ></p>
                    <div class="divider my-2"></div>
                    <p class="text-xs text-text-muted mb-0.5">Итого</p>
                    <p
                      class="result-value text-lg font-bold text-text-primary"
                      x-text="formatMoney(att.total)"
                    ></p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>

        <template x-if="parsedVars.length === 0 && !formula">
          <div class="animate-slide">
            <div
              class="empty-state flex flex-col items-center px-6 py-12 text-center"
            >
              <div
                class="empty-icon mb-6 flex h-20 w-20 items-center justify-center"
              >
                <svg
                  class="h-10 w-10 text-text-muted"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V13.5Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V18Zm2.498-6.75h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V13.5Zm0 2.25h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V18Zm2.504-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5Zm0 2.25h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V18Zm2.498-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5ZM8.25 6h7.5v2.25h-7.5V6ZM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 0 0 2.25 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0 0 12 2.25Z"
                  />
                </svg>
              </div>
              <h2 class="text-balance text-xl font-semibold text-text-primary">
                Введите формулу
              </h2>
              <p
                class="mt-3 max-w-[17rem] text-sm leading-relaxed text-text-muted"
              >
                Напишите формулу расчёта зарплаты выше, и поля для ввода
                создадутся автоматически
              </p>
              <div
                class="mt-7 flex items-center gap-2 text-xs font-medium text-text-tertiary"
              >
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"
                  />
                </svg>
                <span>Или выберите готовый пресет ниже</span>
              </div>
            </div>
          </div>
        </template>
      </div>
    </main>

    <div
      x-show="toast.visible"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 translate-y-4 scale-95"
      x-transition:enter-end="opacity-100 translate-y-0 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 translate-y-0 scale-100"
      x-transition:leave-end="opacity-0 translate-y-4 scale-95"
      class="toast fixed bottom-8 left-1/2 z-50 -translate-x-1/2 px-5 py-3"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
      <div class="flex items-center gap-2.5 whitespace-nowrap">
        <template x-if="toast.type === 'success'">
          <svg
            class="h-5 w-5 text-success"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m4.5 12.75 6 6 9-13.5"
            />
          </svg>
        </template>
        <template x-if="toast.type === 'error'">
          <svg
            class="h-5 w-5 text-error"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
            />
          </svg>
        </template>
        <span
          class="text-sm font-medium text-text-primary"
          x-text="toast.message"
        ></span>
      </div>
    </div>

    <script type="module">
      import Alpine from "alpinejs";

      const tg = globalThis.Telegram?.WebApp;

      const TelegramApp = Object.freeze({
        init() {
          if (!tg) return false;
          tg.ready();
          tg.requestFullscreen?.();
          tg.disableVerticalSwipes?.();
          tg.setHeaderColor?.("#000000");
          tg.setBackgroundColor?.("#000000");
          tg.setBottomBarColor?.("#0a0a0a");
          return true;
        },
        haptic(type = "light") {
          tg?.HapticFeedback?.impactOccurred?.(type);
        },
        notify(type = "success") {
          tg?.HapticFeedback?.notificationOccurred?.(type);
        },
      });

      function safeEvaluate(expression, variables) {
        const tokens = tokenize(expression);
        const rpn = toRPN(tokens);
        return evalRPN(rpn, variables);
      }

      function tokenize(expr) {
        const tokens = [];
        let i = 0;
        const s = expr.replace(/\s+/g, "");

        while (i < s.length) {
          if (
            /\d/.test(s[i]) ||
            (s[i] === "." && i + 1 < s.length && /\d/.test(s[i + 1]))
          ) {
            let num = "";
            while (i < s.length && (/\d/.test(s[i]) || s[i] === ".")) {
              num += s[i++];
            }
            tokens.push({ type: "number", value: parseFloat(num) });
            continue;
          }

          if ("+-*/()".includes(s[i])) {
            tokens.push({ type: "op", value: s[i] });
            i++;
            continue;
          }

          if (/[a-zA-Zа-яА-ЯёЁ_]/.test(s[i])) {
            let name = "";
            while (i < s.length && /[a-zA-Zа-яА-ЯёЁ_0-9]/.test(s[i])) {
              name += s[i++];
            }
            tokens.push({ type: "var", value: name });
            continue;
          }

          i++;
        }
        return tokens;
      }

      function precedence(op) {
        if (op === "+" || op === "-") return 1;
        if (op === "*" || op === "/") return 2;
        return 0;
      }

      function toRPN(tokens) {
        const output = [];
        const ops = [];

        for (const t of tokens) {
          if (t.type === "number" || t.type === "var") {
            output.push(t);
          } else if (t.value === "(") {
            ops.push(t);
          } else if (t.value === ")") {
            while (ops.length && ops[ops.length - 1].value !== "(") {
              output.push(ops.pop());
            }
            ops.pop();
          } else {
            while (
              ops.length &&
              ops[ops.length - 1].value !== "(" &&
              precedence(ops[ops.length - 1].value) >= precedence(t.value)
            ) {
              output.push(ops.pop());
            }
            ops.push(t);
          }
        }

        while (ops.length) output.push(ops.pop());
        return output;
      }

      function evalRPN(rpn, variables) {
        const stack = [];

        for (const t of rpn) {
          if (t.type === "number") {
            stack.push(t.value);
          } else if (t.type === "var") {
            const val = variables[t.value];
            stack.push(typeof val === "number" && !isNaN(val) ? val : 0);
          } else {
            const b = stack.pop() || 0;
            const a = stack.pop() || 0;
            switch (t.value) {
              case "+":
                stack.push(a + b);
                break;
              case "-":
                stack.push(a - b);
                break;
              case "*":
                stack.push(a * b);
                break;
              case "/":
                stack.push(b !== 0 ? a / b : 0);
                break;
            }
          }
        }

        return stack[0] || 0;
      }

      function extractVariables(expression) {
        const tokens = tokenize(expression);
        const vars = [];
        const seen = new Set();
        for (const t of tokens) {
          if (t.type === "var" && !seen.has(t.value)) {
            seen.add(t.value);
            vars.push(t.value);
          }
        }
        return vars;
      }

      const VAR_META = {
        оклад: {
          label: "Оклад к начислению",
          hint: "Ставка × Отработанные часы",
          placeholder: "54264",
          color: "bg-accent/20 text-accent",
        },
        премия_ТО: {
          label: "Премия от ТО",
          hint: "Процент от товарооборота",
          placeholder: "8867",
          color: "bg-success/20 text-success",
        },
        премия_МВО: {
          label: "Премия МВО",
          hint: "На основе выполнения МВО",
          placeholder: "35712",
          color: "bg-warning/20 text-warning",
        },
        ТО: {
          label: "ТО факт за месяц",
          hint: "Фактический товарооборот",
          placeholder: "5364677",
          color: "bg-accent/20 text-accent",
        },
        МВО: {
          label: "МВО Выполнение %",
          hint: "Процент выполнения МВО",
          placeholder: "96",
          color: "bg-warning/20 text-warning",
        },
        штат: {
          label: "Штат без админа",
          hint: "Количество сотрудников",
          placeholder: "4",
          color: "bg-text-tertiary/20 text-text-tertiary",
        },
        план_часы: {
          label: "Плановое кол-во часов",
          hint: "Плановые часы на месяц",
          placeholder: "720",
          color: "bg-text-tertiary/20 text-text-tertiary",
        },
        факт_часы: {
          label: "Отработанные часы",
          hint: "Фактически отработано",
          placeholder: "238",
          color: "bg-accent/20 text-accent",
        },
        ставка: {
          label: "Ставка за час",
          hint: "Оплата за 1 час работы",
          placeholder: "228",
          color: "bg-success/20 text-success",
        },
        МВО_процент: {
          label: "МВО начисленный %",
          hint: "Начисленный процент МВО",
          placeholder: "31",
          color: "bg-warning/20 text-warning",
        },
        salary: {
          label: "Оклад",
          placeholder: "54264",
          color: "bg-accent/20 text-accent",
        },
        bonus: {
          label: "Премия",
          placeholder: "10000",
          color: "bg-success/20 text-success",
        },
        hours: {
          label: "Часы",
          placeholder: "238",
          color: "bg-warning/20 text-warning",
        },
        rate: {
          label: "Ставка",
          placeholder: "228",
          color: "bg-accent/20 text-accent",
        },
      };

      const COLORS = [
        "bg-accent/20 text-accent",
        "bg-success/20 text-success",
        "bg-warning/20 text-warning",
        "bg-error/20 text-error",
        "bg-text-tertiary/20 text-text-tertiary",
      ];

      const PRESETS = {
        default: "оклад + премия_ТО + премия_МВО",
        simple: "ставка * факт_часы",
        full: "оклад + премия_ТО + премия_МВО",
      };

      const ATTESTATION = {
        staff: [
          { name: "Без Атт", ka: 0 },
          { name: "1 Атт", ka: 0.25 },
          { name: "2 Атт", ka: 0.85 },
          { name: "3 Атт", ka: 1.6 },
        ],
        admin: [
          { name: "Без Атт", ka: 0 },
          { name: "1 Атт", ka: 0.5 },
          { name: "2 Атт", ka: 1 },
          { name: "3 Атт", ka: 1.5 },
        ],
      };

      Alpine.data("salaryApp", () => ({
        role: "staff",
        formula: "",
        formulaError: "",
        parsedVars: [],
        values: {},
        result: null,
        attestations: [],
        toast: { visible: false, message: "", type: "success" },
        _toastTimer: null,

        init() {
          TelegramApp.init();
          // this.applyPreset("default");
        },

        destroy() {
          if (this._toastTimer) clearTimeout(this._toastTimer);
        },

        setRole(r) {
          TelegramApp.haptic("light");
          this.role = r;
          if (this.result !== null) {
            this.calculate();
          }
        },

        applyPreset(key) {
          TelegramApp.haptic("light");
          this.formula = PRESETS[key] || "";
          this.parseFormula();
          this.showToast("Пресет применён", "success");
        },

        parseFormula() {
          this.formulaError = "";
          this.result = null;
          this.attestations = [];

          const f = this.formula.trim();
          if (!f) {
            this.parsedVars = [];
            return;
          }

          if (/[^a-zA-Zа-яА-ЯёЁ0-9_+\-*/().\s]/.test(f)) {
            this.formulaError = "Формула содержит недопустимые символы";
            this.parsedVars = [];
            return;
          }

          let depth = 0;
          for (const ch of f) {
            if (ch === "(") depth++;
            if (ch === ")") depth--;
            if (depth < 0) break;
          }
          if (depth !== 0) {
            this.formulaError = "Незакрытые скобки в формуле";
            this.parsedVars = [];
            return;
          }

          try {
            const vars = extractVariables(f);
            if (vars.length === 0) {
              this.formulaError = "Формула не содержит переменных";
              this.parsedVars = [];
              return;
            }

            const oldValues = { ...this.values };
            this.values = {};
            for (const v of vars) {
              this.values[v] = oldValues[v] ?? null;
            }

            this.parsedVars = vars;
          } catch (e) {
            this.formulaError = "Ошибка разбора формулы";
            this.parsedVars = [];
          }
        },

        calculate() {
          TelegramApp.haptic("light");

          const allFilled = this.parsedVars.every(
            (v) =>
              this.values[v] !== null &&
              this.values[v] !== "" &&
              !isNaN(this.values[v]),
          );

          try {
            const vars = {};
            for (const v of this.parsedVars) {
              vars[v] = typeof this.values[v] === "number" ? this.values[v] : 0;
            }

            const res = safeEvaluate(this.formula, vars);
            this.result = Math.round(res * 100) / 100;

            const premiaTO = vars["премия_ТО"] || this.result * 0.15;

            const attData = ATTESTATION[this.role] || ATTESTATION.staff;
            this.attestations = attData.map((a) => {
              const bonus = Math.round(premiaTO * a.ka * 100) / 100;
              return {
                name: a.name,
                ka: a.ka,
                bonus,
                total: Math.round((this.result + bonus) * 100) / 100,
              };
            });

            TelegramApp.notify("success");
          } catch (e) {
            this.result = null;
            this.attestations = [];
            this.showToast("Ошибка вычисления", "error");
            TelegramApp.notify("error");
          }
        },

        resetValues() {
          TelegramApp.haptic("medium");
          for (const v of this.parsedVars) {
            this.values[v] = null;
          }
          this.result = null;
          this.attestations = [];
          this.showToast("Значения сброшены", "success");
        },

        getVarLabel(v) {
          return VAR_META[v]?.label || v.replace(/_/g, " ");
        },

        getVarPlaceholder(v) {
          return VAR_META[v]?.placeholder || "0";
        },

        getVarHint(v) {
          return VAR_META[v]?.hint || null;
        },

        getVarColor(v) {
          if (VAR_META[v]?.color) return VAR_META[v].color;
          const idx = this.parsedVars.indexOf(v) % COLORS.length;
          return COLORS[idx];
        },

        formatMoney(value) {
          if (value === null || value === undefined || isNaN(value))
            return "0 ₽";
          const rounded = Math.round(value);
          return rounded.toLocaleString("ru-RU") + " ₽";
        },

        showToast(message, type = "success") {
          if (this._toastTimer) clearTimeout(this._toastTimer);
          this.toast = { visible: true, message, type };
          this._toastTimer = setTimeout(() => {
            this.toast.visible = false;
            this._toastTimer = null;
          }, 2500);
        },
      }));

      Alpine.start();
    </script>
  </body>
</html>